name: IskakINO Library CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: "1. Arduino Lint"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Arduino Lint
        uses: arduino/arduino-lint-action@v1
        with:
          compliance: specification
          recursive: true
          args: --skip-rule LP018

  build:
    name: "2. Compile Examples"
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        # Menjalankan build untuk ESP8266 dan ESP32 secara paralel
        board: [ "esp8266:esp8266:nodemcuv2", "esp32:esp32:esp32" ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Configure and Install Platforms
        run: |
          URL_ESP8266="https://arduino.esp8266.com/stable/package_esp8266com_index.json"
          URL_ESP32="https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli core update-index --additional-urls $URL_ESP8266,$URL_ESP32
          if [[ "${{ matrix.board }}" == *"esp8266"* ]]; then
            arduino-cli core install esp8266:esp8266 --additional-urls $URL_ESP8266
          else
            arduino-cli core install esp32:esp32 --additional-urls $URL_ESP32
          fi

      - name: Install IskakINO Dependencies
        env:
          MY_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          mkdir -p $HOME/Arduino/libraries
          cd $HOME/Arduino/libraries
          
          echo "Cloning Dependencies from iskakfatoni..."
          # Clone WifiPortal
          git clone --depth 1 https://${MY_TOKEN}@github.com/iskakfatoni/IskakINO_WifiPortal.git || true
          
          # Clone ArduFast (Coba underscore dan dash untuk keamanan)
          git clone --depth 1 https://${MY_TOKEN}@github.com/iskakfatoni/IskakINO_ArduFast.git || \
          git clone --depth 1 https://${MY_TOKEN}@github.com/iskakfatoni/IskakINO-ArduFast.git || true

      - name: Patch Library & Source Conflicts
        run: |
          echo "Running Auto-Patch to fix library inconsistencies..."
          
          # 1. Fix WifiPortal: Hapus baris portal.handle karena statusnya PRIVATE
          find examples -name "*.ino" -exec sed -i '/portal.handle/d' {} +
          
          # 2. Fix ArduFast: Alihkan io.member ke global function (pinMode, digitalWrite, digitalRead)
          find examples -name "*.ino" -exec sed -i 's/io.pinMode/pinMode/g' {} +
          find examples -name "*.ino" -exec sed -i 's/io.digitalWrite/digitalWrite/g' {} +
          find examples -name "*.ino" -exec sed -i 's/io.digitalRead/digitalRead/g' {} +

          # 3. Fix FastNTP: Pastikan tipe data getMillisSinceLastSync sinkron (uint32_t)
          if [ -f "src/IskakINO_FastNTP.cpp" ]; then
            sed -i 's/unsigned long IskakINO_FastNTP::getMillisSinceLastSync/uint32_t IskakINO_FastNTP::getMillisSinceLastSync/g' src/IskakINO_FastNTP.cpp
          fi

      - name: Compile All Examples
        run: |
          LIB_PATH="$HOME/Arduino/libraries"
          for example in $(find examples -name "*.ino"); do
            echo "-------------------------------------------------------"
            echo "Building: $example (${{ matrix.board }})"
            echo "-------------------------------------------------------"
            arduino-cli compile --fqbn ${{ matrix.board }} "$example" --library . --libraries $LIB_PATH
          done

  status:
    name: "3. Final Report"
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: success()
    steps:
      - run: echo "ðŸš€ SUCCESS! IskakINO_FastNTP berhasil melewati semua tahap pengujian."
