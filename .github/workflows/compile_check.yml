name: IskakINO Library CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: "Arduino Lint"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Arduino Lint
        uses: arduino/arduino-lint-action@v1
        with:
          # Menggunakan specification agar pengecekan teknis tetap jalan
          compliance: specification
          # 'none' wajib agar tidak mengecek database pusat (Solusi Error LP018)
          library-manager: none
          recursive: true

  build:
    name: "Compile Examples"
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        # Mengetes di platform target IskakINO (ESP8266 & ESP32)
        board: [ "esp8266:esp8266:nodemcuv2", "esp32:esp32:esp32" ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install Platforms
        run: |
          arduino-cli core update-index
          if [[ "${{ matrix.board }}" == *"esp8266"* ]]; then
            arduino-cli core install esp8266:esp8266
          else
            # Menambahkan URL tambahan khusus untuk ESP32
            arduino-cli config init
            arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
            arduino-cli core update-index
            arduino-cli core install esp32:esp32
          fi

      - name: Install IskakINO Dependencies
        run: |
          # Membuat direktori library untuk dependensi
          mkdir -p $HOME/Arduino/libraries
          cd $HOME/Arduino/libraries
          
          echo "Cloning required IskakINO libraries..."
          # Pastikan URL ini benar sesuai dengan nama repo Anda di GitHub
          git clone https://github.com/iskakfatoni/IskakINO_WifiPortal.git
          git clone https://github.com/iskakfatoni/IskakINO-ArduFast.git

      - name: Compile All Examples
        run: |
          # Mencari semua file .ino di dalam folder examples secara rekursif
          for example in $(find examples -name "*.ino"); do
            echo "-------------------------------------------------------"
            echo "Building Example: $example"
            echo "Board: ${{ matrix.board }}"
            echo "-------------------------------------------------------"
            
            # --library .   -> Menggunakan kode IskakINO_FastNTP di repo ini
            # --libraries .. -> Menggunakan folder dependensi yang di-clone tadi
            arduino-cli compile --fqbn ${{ matrix.board }} "$example" --library . --libraries $HOME/Arduino/libraries
          done

  success-notification:
    name: "Build Result"
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: success()
    steps:
      - name: Status
        run: echo "ðŸŽ‰ Semua file src dan 10 examples berhasil di-compile tanpa error!"
